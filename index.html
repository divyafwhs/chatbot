<!-- ========================================
     CHARLOTTE CHATBOT FOR SHOPIFY - UPDATED VERSION
     With Product Image & Link Display Support
     Paste this ENTIRE code BEFORE </body> tag
     ======================================== -->

<style>
  /* Wix Madefor Display Font Faces */
  @font-face {
    font-family: 'Wix Madefor Display';
    src: url('https://cdn.jsdelivr.net/gh/google/fonts@main/ofl/wixmadefordisplay/WixMadeforDisplay-Regular.ttf') format('truetype');
    font-weight: 400;
    font-style: normal;
    font-display: swap;
  }
  
  @font-face {
    font-family: 'Wix Madefor Display';
    src: url('https://cdn.jsdelivr.net/gh/google/fonts@main/ofl/wixmadefordisplay/WixMadeforDisplay-Medium.ttf') format('truetype');
    font-weight: 500;
    font-style: normal;
    font-display: swap;
  }
  
  @font-face {
    font-family: 'Wix Madefor Display';
    src: url('https://cdn.jsdelivr.net/gh/google/fonts@main/ofl/wixmadefordisplay/WixMadeforDisplay-SemiBold.ttf') format('truetype');
    font-weight: 600;
    font-style: normal;
    font-display: swap;
  }
  
  @font-face {
    font-family: 'Wix Madefor Display';
    src: url('https://cdn.jsdelivr.net/gh/google/fonts@main/ofl/wixmadefordisplay/WixMadeforDisplay-Bold.ttf') format('truetype');
    font-weight: 700;
    font-style: normal;
    font-display: swap;
  }
  
  @font-face {
    font-family: 'Wix Madefor Display';
    src: url('https://cdn.jsdelivr.net/gh/google/fonts@main/ofl/wixmadefordisplay/WixMadeforDisplay-ExtraBold.ttf') format('truetype');
    font-weight: 800;
    font-style: normal;
    font-display: swap;
  }

  /* Charlotte Chatbot Styles */
  .charlotte-chatbot-wrapper * { box-sizing: border-box; margin: 0; padding: 0; }
  
  .charlotte-chatbot-wrapper {
    --reclaim-teal: #2B6F6F;
    --reclaim-teal-dark: #1F5353;
    --reclaim-teal-light: #3D8585;
    --warm-white: #F0EEE8;
    --off-white: #FDFCFB;
    --soft-beige: #E8E4DB;
    --charcoal: #2C2C2C;
    --accent-copper: #B8956A;
    --light-border: rgba(43, 111, 111, 0.15);
    font-family: 'Wix Madefor Display', -apple-system, BlinkMacSystemFont, sans-serif;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
  }
  
  /* Chatbot Trigger */
  .charlotte-trigger {
    position: fixed;
    bottom: 2rem;
    right: 2rem;
    background: var(--warm-white);
    color: var(--warm-white);
    border: 4px solid var(--reclaim-teal);
    border-radius: 50%;
    width: 64px;
    height: 64px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    box-shadow: 0 4px 20px rgba(43, 111, 111, 0.25);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    z-index: 10000;
    overflow: hidden;
    padding: 0;
    opacity: 1;
    transform: scale(1);
    pointer-events: all;
    font-family: 'Wix Madefor Display', sans-serif;
    font-size: 1.5rem;
    font-weight: 700;
    letter-spacing: -0.02em;
  }
  
  .charlotte-trigger.open {
    opacity: 0;
    transform: scale(0.8);
    pointer-events: none;
  }
  
  .charlotte-trigger img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }
  
  /* Fallback text if image doesn't load */
  .charlotte-trigger::before {
    content: 'C';
    position: absolute;
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.75rem;
    font-weight: 700;
    color: var(--reclaim-teal);
    opacity: 0;
    transition: opacity 0.3s;
  }
  
  .charlotte-trigger.image-error::before {
    opacity: 1;
  }
  
  .charlotte-trigger.image-error img {
    opacity: 0;
  }
  
  .charlotte-trigger:hover:not(.open) {
    transform: translateY(-2px) scale(1.05);
    box-shadow: 0 8px 30px rgba(43, 111, 111, 0.35);
    border-color: var(--reclaim-teal-dark);
  }
  
  /* Chat Container */
  .charlotte-container {
    position: fixed;
    bottom: 2rem;
    right: 2rem;
    width: 420px;
    height: 650px;
    background: var(--warm-white);
    border-radius: 20px;
    box-shadow: 0 8px 40px rgba(43, 111, 111, 0.15);
    display: flex;
    flex-direction: column;
    overflow: hidden;
    z-index: 9999;
    opacity: 0;
    transform: translateY(20px) scale(0.95);
    pointer-events: none;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  }
  
  .charlotte-container.open {
    opacity: 1;
    transform: translateY(0) scale(1);
    pointer-events: all;
  }
  
  /* Header */
  .charlotte-header {
    background: linear-gradient(135deg, var(--reclaim-teal) 0%, var(--reclaim-teal-dark) 100%);
    padding: 1.75rem 2rem;
    position: relative;
  }
  
  .charlotte-header-content { display: flex; align-items: center; gap: 1rem; }
  
  .charlotte-logo {
    width: 52px;
    height: 52px;
    background: var(--warm-white);
    border-radius: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    overflow: hidden;
    padding: 6px;
  }
  
  .charlotte-logo img {
    width: 100%;
    height: 100%;
    object-fit: contain;
  }
  
  .charlotte-title {
    font-family: 'Wix Madefor Display', sans-serif;
    font-size: 1.625rem;
    font-weight: 700;
    color: var(--warm-white);
    margin: 0;
    line-height: 1.1;
    letter-spacing: -0.02em;
  }
  
  .charlotte-status {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-top: 0.375rem;
    color: var(--warm-white);
    font-size: 0.875rem;
    font-weight: 400;
    opacity: 0.92;
    letter-spacing: 0.01em;
  }
  
  .charlotte-status-dot {
    width: 8px;
    height: 8px;
    background: var(--warm-white);
    border-radius: 50%;
    animation: charlotte-pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
  }
  
  @keyframes charlotte-pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
  
  .charlotte-close {
    position: absolute;
    top: 1.75rem;
    right: 2rem;
    background: none;
    border: none;
    color: var(--warm-white);
    cursor: pointer;
    width: 24px;
    height: 24px;
    font-size: 1.5rem;
    opacity: 0.8;
    transition: opacity 0.2s;
  }
  
  .charlotte-close:hover { opacity: 1; }
  
  /* Messages */
  .charlotte-messages {
    flex: 1;
    overflow-y: auto;
    padding: 2rem;
    background: var(--warm-white);
    scroll-behavior: smooth;
  }
  
  .charlotte-messages::-webkit-scrollbar { width: 6px; }
  .charlotte-messages::-webkit-scrollbar-track { background: transparent; }
  .charlotte-messages::-webkit-scrollbar-thumb { background: var(--light-border); border-radius: 3px; }
  
  .charlotte-message {
    display: flex;
    gap: 0.875rem;
    margin-bottom: 1.75rem;
    animation: charlotte-fadeIn 0.4s ease-out;
  }
  
  @keyframes charlotte-fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
  
  .charlotte-message.user { flex-direction: row-reverse; }
  
  .charlotte-avatar {
    width: 38px;
    height: 38px;
    border-radius: 11px;
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1rem;
    font-weight: 700;
    color: var(--warm-white);
    overflow: hidden;
  }
  
  .charlotte-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  
  .charlotte-message.user .charlotte-avatar {
    background: linear-gradient(135deg, var(--accent-copper), #9A7854);
  }
  
  .charlotte-bubble {
    background: var(--soft-beige);
    padding: 1.125rem 1.375rem;
    border-radius: 18px;
    font-size: 0.9375rem;
    line-height: 1.6;
    color: var(--charcoal);
    max-width: 280px;
    word-wrap: break-word;
    border-bottom-left-radius: 4px;
    letter-spacing: 0.005em;
    font-weight: 400;
  }
  
  .charlotte-message.user .charlotte-bubble {
    background: linear-gradient(135deg, var(--reclaim-teal), var(--reclaim-teal-light));
    color: var(--warm-white);
    border-bottom-left-radius: 18px;
    border-bottom-right-radius: 4px;
    font-weight: 500;
  }
  
  .charlotte-time {
    font-size: 0.75rem;
    color: rgba(43, 111, 111, 0.5);
    margin-top: 0.625rem;
    padding: 0 0.25rem;
    font-weight: 500;
    letter-spacing: 0.02em;
  }
  
  /* NEW: Product Card Styles */
  .charlotte-product-card {
    background: var(--off-white);
    border: 2px solid var(--light-border);
    border-radius: 16px;
    overflow: hidden;
    margin-top: 1rem;
    transition: all 0.3s ease;
    box-shadow: 0 2px 8px rgba(43, 111, 111, 0.08);
  }
  
  .charlotte-product-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 16px rgba(43, 111, 111, 0.15);
    border-color: var(--reclaim-teal);
  }
  
  .charlotte-product-image {
    width: 100%;
    height: 180px;
    object-fit: cover;
    display: block;
    background: var(--soft-beige);
  }
  
  .charlotte-product-info {
    padding: 1rem 1.25rem;
  }
  
  .charlotte-product-name {
    font-size: 1.0625rem;
    font-weight: 600;
    color: var(--charcoal);
    margin-bottom: 0.5rem;
    letter-spacing: -0.01em;
  }
  
  .charlotte-product-price {
    font-size: 1.125rem;
    font-weight: 700;
    color: var(--reclaim-teal);
    margin-bottom: 0.75rem;
  }
  
  .charlotte-product-link {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    background: var(--reclaim-teal);
    color: var(--warm-white);
    text-decoration: none;
    padding: 0.625rem 1.125rem;
    border-radius: 10px;
    font-size: 0.875rem;
    font-weight: 600;
    transition: all 0.2s ease;
    letter-spacing: 0.01em;
  }
  
  .charlotte-product-link:hover {
    background: var(--reclaim-teal-dark);
    transform: translateX(2px);
  }
  
  /* Typing Indicator */
  .charlotte-typing {
    display: flex;
    gap: 0.875rem;
    margin-bottom: 1.75rem;
    animation: charlotte-fadeIn 0.4s ease-out;
  }
  
  .charlotte-typing.hidden { display: none; }
  
  .charlotte-typing-bubble {
    background: var(--soft-beige);
    padding: 1.125rem 1.375rem;
    border-radius: 18px;
    border-bottom-left-radius: 4px;
    display: flex;
    gap: 0.375rem;
    align-items: center;
  }
  
  .charlotte-typing-dot {
    width: 8px;
    height: 8px;
    background: var(--reclaim-teal);
    border-radius: 50%;
    animation: charlotte-bounce 1.4s infinite ease-in-out;
  }
  
  .charlotte-typing-dot:nth-child(1) { animation-delay: -0.32s; }
  .charlotte-typing-dot:nth-child(2) { animation-delay: -0.16s; }
  
  @keyframes charlotte-bounce { 0%, 80%, 100% { transform: translateY(0); opacity: 0.5; } 40% { transform: translateY(-8px); opacity: 1; } }
  
  /* Input */
  .charlotte-input-container {
    padding: 1.375rem 2rem 1.5rem;
    background: var(--soft-beige);
    border-top: 1px solid var(--light-border);
  }
  
  .charlotte-input-wrapper { display: flex; gap: 0.875rem; align-items: flex-end; }
  
  .charlotte-input {
    flex: 1;
    background: var(--off-white);
    border: 1.5px solid var(--light-border);
    border-radius: 14px;
    padding: 0.9375rem 1.125rem;
    font-family: 'Wix Madefor Display', sans-serif;
    font-size: 0.9375rem;
    font-weight: 400;
    color: var(--charcoal);
    resize: none;
    max-height: 120px;
    min-height: 46px;
    transition: all 0.2s ease;
    letter-spacing: 0.005em;
  }
  
  .charlotte-input:focus {
    outline: none;
    border-color: var(--reclaim-teal);
    box-shadow: 0 0 0 3px rgba(43, 111, 111, 0.1);
  }
  
  .charlotte-input::placeholder { color: rgba(43, 111, 111, 0.4); font-weight: 400; }
  .charlotte-input:disabled { opacity: 0.6; cursor: not-allowed; }
  
  .charlotte-send {
    background: var(--reclaim-teal);
    color: var(--warm-white);
    border: none;
    border-radius: 12px;
    width: 46px;
    height: 46px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s ease;
    flex-shrink: 0;
    font-size: 1.25rem;
    font-weight: 600;
  }
  
  .charlotte-send:hover:not(:disabled) {
    background: var(--reclaim-teal-dark);
    transform: translateY(-1px);
  }
  
  .charlotte-send:disabled { opacity: 0.5; cursor: not-allowed; }
  
  @media (max-width: 480px) {
    .charlotte-container {
      width: calc(100vw - 2rem);
      height: calc(100vh - 2rem);
      bottom: 1rem;
      right: 1rem;
      border-radius: 18px;
    }
    .charlotte-trigger { bottom: 1.5rem; right: 1.5rem; }
    .charlotte-product-card { max-width: 100%; }
  }
</style>

<!-- Charlotte Chatbot HTML -->
<div class="charlotte-chatbot-wrapper">
  <!-- Chat Trigger Button -->
  <button class="charlotte-trigger" id="charlotteTrigger" aria-label="Open chat">
    <img src="https://i.postimg.cc/4yhWxnWp/15._R_GREEN_CIRCLE_2x.png" 
         alt="Charlotte Assistant"
         id="triggerImage"
         crossorigin="anonymous"
         onerror="this.parentElement.classList.add('image-error')">
  </button>
  
  <div class="charlotte-container" id="charlotteContainer">
    <div class="charlotte-header">
      <div class="charlotte-header-content">
        <div class="charlotte-logo">
          <img src="https://i.postimg.cc/4yhWxnWp/15._R_GREEN_CIRCLE_2x.png" alt="Reclaim Nation" id="headerLogo">
        </div>
        <div>
          <h1 class="charlotte-title">Charlotte</h1>
          <div class="charlotte-status">
            <span class="charlotte-status-dot"></span>
            <span>Interior Design Assistant</span>
          </div>
        </div>
      </div>
      <button class="charlotte-close" id="charlotteClose" aria-label="Close">↓</button>
    </div>
    
    <div class="charlotte-messages" id="charlotteMessages">
      <div class="charlotte-message assistant">
        <div class="charlotte-avatar">
          <img src="https://i.postimg.cc/4yhWxnWp/15._R_GREEN_CIRCLE_2x.png" alt="Charlotte">
        </div>
        <div>
          <div class="charlotte-bubble">Welcome to Reclaim Nation. I'm Charlotte, your interior design assistant. I can help you explore our furniture collections, discuss finishes and materials, and visualize pieces in your space. What brings you here today?</div>
          <div class="charlotte-time" id="initialTime"></div>
        </div>
      </div>
    </div>
    
    <div class="charlotte-typing hidden" id="charlotteTyping">
      <div class="charlotte-avatar" style="background: linear-gradient(135deg, var(--reclaim-teal), var(--reclaim-teal-light)); padding: 4px;">
        <img src="https://i.postimg.cc/4yhWxnWp/15._R_GREEN_CIRCLE_2x.png" alt="Charlotte">
      </div>
      <div class="charlotte-typing-bubble">
        <div class="charlotte-typing-dot"></div>
        <div class="charlotte-typing-dot"></div>
        <div class="charlotte-typing-dot"></div>
      </div>
    </div>
    
    <div class="charlotte-input-container">
      <div class="charlotte-input-wrapper">
        <textarea id="charlotteInput" class="charlotte-input" placeholder="Ask about furniture, collections, or visualize your space…" rows="1"></textarea>
        <button class="charlotte-send" id="charlotteSend" aria-label="Send">→</button>
      </div>
    </div>
  </div>
</div>

<script>
(function() {
  // ⬇️⬇️⬇️ UPDATE YOUR WEBHOOK URL HERE ⬇️⬇️⬇️
  const WEBHOOK = 'https://fwhome.app.n8n.cloud/webhook-test/4d77e3ce-f91b-45e9-9489-c81bb6e49009';
  // ⬆️⬆️⬆️ UPDATE YOUR WEBHOOK URL HERE ⬆️⬆️⬆️
  
  const trigger = document.getElementById('charlotteTrigger');
  const container = document.getElementById('charlotteContainer');
  const closeBtn = document.getElementById('charlotteClose');
  const messages = document.getElementById('charlotteMessages');
  const input = document.getElementById('charlotteInput');
  const sendBtn = document.getElementById('charlotteSend');
  const typing = document.getElementById('charlotteTyping');
  
  let isOpen = false, isLoading = false;
  
  document.getElementById('initialTime').textContent = new Date().toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
  
  function toggle() {
    isOpen = !isOpen;
    container.classList.toggle('open');
    trigger.classList.toggle('open');
    if (isOpen) input.focus();
  }
  
  trigger.addEventListener('click', toggle);
  closeBtn.addEventListener('click', toggle);
  
  // NEW: Function to create product card HTML
  function createProductCard(product) {
    return `
      <div class="charlotte-product-card">
        <img src="${product.image_src}" 
             alt="${product.product_name || 'Product'}" 
             class="charlotte-product-image"
             onerror="this.src='https://via.placeholder.com/350x180?text=Image+Not+Available'">
        <div class="charlotte-product-info">
          <div class="charlotte-product-name">${product.product_name || 'Product'}</div>
          ${product.price ? `<div class="charlotte-product-price">$${product.price}</div>` : ''}
          <a href="${product.product_url}" 
             target="_blank" 
             class="charlotte-product-link">
            View Product →
          </a>
        </div>
      </div>
    `;
  }
  
  function addMessage(content, role = 'assistant', products = null) {
    const div = document.createElement('div');
    div.className = `charlotte-message ${role}`;
    const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
    
    const logoUrl = document.getElementById('headerLogo').src;
    const avatarContent = role === 'assistant' 
      ? `<img src="${logoUrl}" alt="Charlotte">` 
      : 'Y';
    
    // Build message content
    let messageContent = `<div class="charlotte-bubble">${content}</div>`;
    
    // Add product cards if available
    if (products && products.length > 0 && role === 'assistant') {
      products.forEach(product => {
        messageContent += createProductCard(product);
      });
    }
    
    div.innerHTML = `
      <div class="charlotte-avatar" style="${role === 'assistant' ? 'background: linear-gradient(135deg, var(--reclaim-teal), var(--reclaim-teal-light)); padding: 4px;' : ''}">
        ${avatarContent}
      </div>
      <div>
        ${messageContent}
        <div class="charlotte-time">${time}</div>
      </div>
    `;
    
    messages.appendChild(div);
    messages.scrollTop = messages.scrollHeight;
  }
  
  async function send() {
    const text = input.value.trim();
    if (!text || isLoading) return;
    
    addMessage(text, 'user');
    input.value = '';
    input.style.height = 'auto';
    
    isLoading = true;
    typing.classList.remove('hidden');
    sendBtn.disabled = true;
    input.disabled = true;
    messages.scrollTop = messages.scrollHeight;
    
    try {
      const res = await fetch(WEBHOOK, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({message: text})
      });
      
      if (!res.ok) throw new Error('Network error');
      
      const data = await res.json();
      typing.classList.add('hidden');
      
      // Extract text reply and products from response
      const reply = data.reply || data.response || 'I received your message.';
      const products = data.products || [];
      
      addMessage(reply, 'assistant', products);
    } catch (err) {
      console.error('Charlotte error:', err);
      typing.classList.add('hidden');
      addMessage("We're having trouble reaching the design assistant. Please try again in a moment.");
    } finally {
      isLoading = false;
      sendBtn.disabled = false;
      input.disabled = false;
      input.focus();
    }
  }
  
  sendBtn.addEventListener('click', send);
  input.addEventListener('keypress', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      send();
    }
  });
  input.addEventListener('input', function() {
    this.style.height = 'auto';
    this.style.height = Math.min(this.scrollHeight, 120) + 'px';
  });
})();
</script>

<!-- END Charlotte Chatbot -->
